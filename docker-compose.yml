services:
  mongodb:
    image: mongo:latest
    container_name: mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: music_app
    volumes:
      - mongo-data:/data/db
      - mongodb_config:/data/configdb
      - ./databases/mongodb/init.js:/docker-entrypoint-initdb.d/init.js:ro
    networks:
      - app-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ==================== NEO4J SERVICE ====================
  neo4j:
    image: neo4j:5.14-community
    container_name: neo4j
    restart: unless-stopped
    ports:
      - "7474:7474"      # Neo4j Browser (HTTP)
      - "7687:7687"      # Bolt protocol
    environment:
      # Autenticación
      - NEO4J_AUTH=neo4j/neo4j_password
      
      # Configuración de memoria
      - NEO4J_dbms_memory_heap_initial__size=512M
      - NEO4J_dbms_memory_heap_max__size=2G
      - NEO4J_dbms_memory_pagecache_size=1G
      
      # Configuración de seguridad
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*,gds.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*,gds.*
      
      # Configuración de red
      - NEO4J_server_bolt_advertised__address=:7687
      - NEO4J_server_http_advertised__address=:7474
      
      # Plugins
      - NEO4JLABS_PLUGINS=["apoc", "graph-data-science"]
      
      # Logs
      - NEO4J_dbms_logs_debug_level=INFO
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
      - neo4j-import:/var/lib/neo4j/import
      - neo4j-plugins:/plugins
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server /usr/local/etc/redis/redis.conf --requirepass redis_password
    volumes:
      - redis-data:/data
      - ./databases/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "redis_password", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  minio:
    image: minio/minio:latest
    container_name: minio
    restart: unless-stopped
    ports:
      - "9000:9000"      # API
      - "9001:9001"      # Console
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3001
      - MONGODB_URI=mongodb://admin:admin123@mongodb:27017/music_app?authSource=admin
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=redis_password
      - JWT_SECRET=your_jwt_secret
      - JWT_EXPIRES_IN=15m
      - REFRESH_TOKEN_EXPIRES_IN=7d
      - MINIO_ENDPOINT=minio
      - MINIO_PORT=9000
      - MINIO_USE_SSL=false
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
    ports:
      - "3001:3001"
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  music-service:
    build:
      context: ./services/music-service
      dockerfile: Dockerfile
    container_name: music-service
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3002
      - MONGODB_URI=mongodb://admin:admin123@mongodb:27017/music_app?authSource=admin
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=redis_password
      - EXTERNAL_API_URL=https://api.example.com
      - EXTERNAL_API_KEY=your_api_key_here
      - MINIO_ENDPOINT=minio
      - MINIO_PORT=9000
      - MINIO_USE_SSL=false
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
    ports:
      - "3002:3002"
    volumes:
      - ./services/music-service/uploads:/app/uploads
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ==================== RECOMMENDATIONS SERVICE ====================
  recommendation-service:
    build:
      context: ./services/recommendation-service
      dockerfile: Dockerfile
    container_name: recommendation-service
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3003
      
      # MongoDB (para sincronización)
      - MONGODB_URI=mongodb://admin:admin123@mongodb:27017/music_app?authSource=admin
      
      # Neo4j
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=neo4j_password
      
      # Redis (para caché de recomendaciones)
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=redis_password
      - REDIS_CACHE_TTL=300
      
      # Configuración de sincronización
      - SYNC_INTERVAL_MINUTES=30
      - SYNC_HISTORY_DAYS=30
      - AUTO_SYNC_ON_START=true
    ports:
      - "3003:3003"
    depends_on:
      mongodb:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      # Para logs de sincronización
      - recommendation-logs:/app/logs
  nginx:
    build:
      context: .
      dockerfile: nginx/Dockerfile
    container_name: auth_nginx
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - auth-service
      - music-service
      - recommendation-service
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  sync-service:
    image: node:18
    container_name: sync-service
    working_dir: /app
    volumes:
      - ./services/recommendation-service:/app
    command: ["node", "sync-service.js"]
    depends_on:
      mongodb:
        condition: service_healthy
      neo4j:
        condition: service_healthy
    networks:
      - app-network
    restart: "no"

volumes:
  mongo-data:
  mongodb_config:
  redis-data:
  minio-data:
  neo4j-data:
  neo4j-logs:
  neo4j-import:
  neo4j-plugins:
  recommendation-logs:

networks:
  app-network:
    driver: bridge